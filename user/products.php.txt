?php
session_start();
require_once "../config/db.php";

if (!isset($_SESSION['user_id']) || $_SESSION['role_id'] != 2) {
    header("Location: ../public/login.html");
    exit();
}

$sql = "
SELECT p.product_id, p.product_name, p.price, p.stock, p.image,
       c.category_name
FROM products p
JOIN categories c ON p.category_id = c.category_id
ORDER BY p.created_at DESC
";
$result = mysqli_query($conn, $sql);
?>
<!DOCTYPE html>
<html>
<head>
    <title>Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4">
    <h3 class="mb-4">Available Products</h3>

    <div class="row">
        <?php while ($row = mysqli_fetch_assoc($result)) { ?>
            <div class="col-md-4 mb-4">
                <div class="card">
                    <img src="../uploads/<?= $row['image']; ?>" class="card-img-top" height="200">
                    <div class="card-body">
                        <h5><?= $row['product_name']; ?></h5>
                        <p>Category: <?= $row['category_name']; ?></p>
                        <p>Price: TZS <?= number_format($row['price']); ?></p>
                        <p>Stock: <?= $row['stock']; ?></p>

                        <?php if ($row['stock'] > 0) { ?>
                            <a href="place_order.php?id=<?= $row['product_id']; ?>" 
                               class="btn btn-primary w-100">Order Now</a>
                        <?php } else { ?>
                            <button class="btn btn-secondary w-100" disabled>Out of Stock</button>
                        <?php } ?>
                    </div>
                </div>
            </div>
        <?php } ?>
    </div>
</div>

</body>
</html>